import java.util.ArrayList;
import java.util.List;

import org.bson.Document;
import org.bson.conversions.Bson;

import com.mongodb.client.FindIterable;
import com.mongodb.client.MongoClient;
import com.mongodb.client.MongoClients;
import com.mongodb.client.MongoCollection;
import com.mongodb.client.MongoCursor;
import com.mongodb.client.MongoDatabase;
import com.mongodb.client.model.Filters;
import com.mongodb.client.model.Projections;
import com.mongodb.client.model.Sorts;
import com.mongodb.client.model.Updates;

public class ConcesionarioYo {

    public static void main(String[] args) {
        // Conexión con try-with-resources para cerrar automáticamente
        try (MongoClient cliente = MongoClients.create()) {
            System.out.println("== Conexión a MongoDB establecida ==");

            MongoDatabase db = cliente.getDatabase("Concesionario");
            System.out.println("Base de datos seleccionada: Concesionario");

            MongoCollection<Document> colCoches = db.getCollection("Coches");
            MongoCollection<Document> colPersonas = db.getCollection("Personas");

            System.out.println();

            // EJ1 - Buscar coches modelo "Rolls" y mostrar JSON completo
            System.out.println("-- EJ1 -- Coches modelo Rolls (JSON completo)");
            Bson filtroE1 = Filters.eq("Model", "Rolls");
            try (MongoCursor<Document> cur = colCoches.find(filtroE1).iterator()) {
                while (cur.hasNext()) {
                    System.out.println(cur.next().toJson());
                }
            }

            System.out.println();

            // EJ2 - Buscar coches modelo "Ford" y obtener el surname de su propietario
            // (se asume que en la colección Personas hay un array "coches" con id_car)
            System.out.println("-- EJ2 -- Surnames de propietarios de coches Ford");
            Bson filtroFord = Filters.eq("Model", "Ford");
            FindIterable<Document> fords = colCoches.find(filtroFord);
            for (Document coche : fords) {
                Integer idCar = coche.getInteger("id_car");
                if (idCar == null) {
                    System.out.println("Coche sin id_car: " + coche.toJson());
                    continue;
                }
                // Buscar la persona que tenga ese id_car en su array "coches"
                Document propietario = colPersonas.find(Filters.in("coches", idCar)).first();
                if (propietario != null) {
                    System.out.println("Coche id " + idCar + " -> Propietario surname: "
                            + propietario.getString("surname"));
                } else {
                    System.out.println("Coche id " + idCar + " -> No se encontró propietario en Personas.");
                }
            }

            System.out.println();

            // EJ3 - Ford con Year >1995 y <2000, mostrar Value y ordenados por Value
            System.out.println("-- EJ3 -- Ford año (1996..1999) ordenados por Value (mostrar Value)");
            Bson filtroE3 = Filters.and(Filters.eq("Model", "Ford"), Filters.gt("Year", 1995), Filters.lt("Year", 2000));
            try (MongoCursor<Document> cur = colCoches.find(filtroE3).sort(Sorts.ascending("Value")).iterator()) {
                if (!cur.hasNext()) {
                    System.out.println("No hay coches Ford entre 1996 y 1999.");
                } else {
                    while (cur.hasNext()) {
                        Document c = cur.next();
                        System.out.println("id_car=" + c.getInteger("id_car") + " Value=" + c.get("Value"));
                    }
                }
            }

            System.out.println();

            // EJ4 - Buscar coches (Ford o Rolls) que pertenezcan a la persona con surname "Juan"
            // y obtener la matrícula de esos coches
            System.out.println("-- EJ4 -- Matrículas de coches (Ford o Rolls) de la persona 'Juan'");
            Document personaJuan = colPersonas.find(Filters.eq("surname", "Juan")).first();
            if (personaJuan == null) {
                System.out.println("No se encontró ninguna persona con surname 'Juan'.");
            } else {
                // obtener lista de ids de coches del array "coches"
                List<Integer> listaCochesJuan = new ArrayList<>();
                Object cochesObj = personaJuan.get("coches");
                if (cochesObj instanceof List<?>) {
                    for (Object o : (List<?>) cochesObj) {
                        if (o instanceof Integer) listaCochesJuan.add((Integer) o);
                        else if (o instanceof Double) listaCochesJuan.add(((Double) o).intValue()); // por si vienen como double
                    }
                }
                if (listaCochesJuan.isEmpty()) {
                    System.out.println("La persona 'Juan' no tiene coches listados.");
                } else {
                    Bson filtroModelos = Filters.or(Filters.eq("Model", "Ford"), Filters.eq("Model", "Rolls"));
                    Bson filtroCochesJuan = Filters.in("id_car", listaCochesJuan);
                    try (MongoCursor<Document> cur = colCoches.find(Filters.and(filtroModelos, filtroCochesJuan)).iterator()) {
                        while (cur.hasNext()) {
                            Document c = cur.next();
                            System.out.println("id_car=" + c.getInteger("id_car") + " Matrícula=" + c.getString("Matrícula"));
                        }
                    }
                }
            }

            System.out.println();

            // EJ5 - Proyección Model, Matrícula y Value, cuyos dueños son de City "London" y Year < 1994,
            // ordenados por Year
            System.out.println("-- EJ5 -- Proyección (Model, Matrícula, Value) para coches de dueños en London y Year < 1994");
            // 1) Obtener ids de coches de las personas de London
            List<Integer> cochesDeLondon = new ArrayList<>();
            try (MongoCursor<Document> curPers = colPersonas.find(Filters.eq("City", "London")).iterator()) {
                while (curPers.hasNext()) {
                    Document p = curPers.next();
                    Object arr = p.get("coches");
                    if (arr instanceof List<?>) {
                        for (Object idObj : (List<?>) arr) {
                            if (idObj instanceof Integer) cochesDeLondon.add((Integer) idObj);
                            else if (idObj instanceof Double) cochesDeLondon.add(((Double) idObj).intValue());
                        }
                    }
                }
            }
            if (cochesDeLondon.isEmpty()) {
                System.out.println("No hay coches asociados a personas en London.");
            } else {
                Bson filtroE5 = Filters.and(Filters.in("id_car", cochesDeLondon), Filters.lt("Year", 1994));
                Bson proyeccionE5 = Projections.include("Model", "Matrícula", "Value", "Year", "id_car");
                try (MongoCursor<Document> cur = colCoches.find(filtroE5).projection(proyeccionE5).sort(Sorts.ascending("Year")).iterator()) {
                    while (cur.hasNext()) {
                        Document c = cur.next();
                        System.out.println(c.toJson());
                    }
                }
            }

            System.out.println();

            // EJ6 - Obtener la ciudad de las personas que tienen dos coches
            System.out.println("-- EJ6 -- Ciudades de personas con exactamente 2 coches");
            Bson filtroE6 = Filters.size("coches", 2);
            try (MongoCursor<Document> cur = colPersonas.find(filtroE6).iterator()) {
                if (!cur.hasNext()) {
                    System.out.println("No hay personas con exactamente 2 coches.");
                } else {
                    while (cur.hasNext()) {
                        Document p = cur.next();
                        System.out.println("surname=" + p.getString("surname") + " City=" + p.getString("City"));
                    }
                }
            }

            System.out.println();

            // EJ7 - Buscar coches cuyo modelo contiene una "r" (insensible a mayúsculas), ordenados por Model
            System.out.println("-- EJ7 -- Coches cuyo Model contiene 'r' (regex, case-insensitive), ordenados por Model");
            Bson filtroE7 = Filters.regex("Model", "r", "i");
            try (MongoCursor<Document> cur = colCoches.find(filtroE7).sort(Sorts.ascending("Model")).iterator()) {
                while (cur.hasNext()) {
                    System.out.println(cur.next().toJson());
                }
            }

            System.out.println();

            // EJ8 - Buscar la persona propietaria del coche con id_car = 107; mostrar surname, name y city
            System.out.println("-- EJ8 -- Propietario del coche id_car = 107");
            int idBuscado = 107;
            Document coche107 = colCoches.find(Filters.eq("id_car", idBuscado)).first();
            if (coche107 == null) {
                System.out.println("No existe un coche con id_car = " + idBuscado);
            } else {
                Document propietario107 = colPersonas.find(Filters.in("coches", idBuscado)).first();
                if (propietario107 == null) {
                    System.out.println("No se encontró propietario para el coche " + idBuscado);
                } else {
                    String surname = propietario107.getString("surname");
                    String name = propietario107.getString("name"); // puede que no exista el campo
                    String city = propietario107.getString("City");
                    System.out.println("Propietario del coche " + idBuscado + ": surname=" + surname + ", name=" + (name != null ? name : "(sin name)") + ", City=" + city);
                }
            }

            System.out.println();

            // EJ9 - Buscar personas con 2 coches y mostrar proyección con surname
            System.out.println("-- EJ9 -- Personas con 2 coches (mostrar surname)");
            Bson filtroE9 = Filters.size("coches", 2);
            Bson proyE9 = Projections.include("surname");
            try (MongoCursor<Document> cur = colPersonas.find(filtroE9).projection(proyE9).iterator()) {
                while (cur.hasNext()) {
                    Document p = cur.next();
                    System.out.println("surname: " + p.getString("surname"));
                }
            }

            System.out.println();

            // EJ10 - Modificar el Value del coche con id_car 101 al valor 2000
            System.out.println("-- EJ10 -- Actualizar Value del coche id_car = 101 a 2000");
            Bson filtroE10 = Filters.eq("id_car", 101);
            colCoches.updateOne(filtroE10, Updates.set("Value", 2000));
            Document actualizado = colCoches.find(Filters.and(filtroE10, Filters.eq("Value", 2000))).first();
            if (actualizado != null) {
                System.out.println("Actualizado correctamente: " + actualizado.toJson());
            } else {
                System.out.println("No se encontró o no se actualizó el coche id_car=101.");
            }

            System.out.println();

            // EJ11 - Añadir un coche Modelo Mercedes año:2001 id_coche:200 valor:3500 (y matrícula)
            System.out.println("-- EJ11 -- Insertar nuevo coche (Mercedes, Year 2001, id_car 200, Value 3500)");
            Document nuevoMercedes = new Document("Model", "Mercedes")
                    .append("Year", 2001)
                    .append("id_car", 200)
                    .append("Value", 3500)
                    .append("Matrícula", "M-200-XYZ");
            colCoches.insertOne(nuevoMercedes);
            System.out.println("Coche añadido: " + nuevoMercedes.toJson());

            System.out.println();

            // EJ12 - Modificar persona con id_persona:4 y añadir al array coches el id_coche:200
            System.out.println("-- EJ12 -- Añadir id_car 200 al array 'coches' de la persona con id_persona = 4");
            Bson filtroE12 = Filters.eq("id_persona", 4);
            colPersonas.updateOne(filtroE12, Updates.push("coches", 200));
            Document persona4 = colPersonas.find(filtroE12).first();
            if (persona4 != null) {
                System.out.println("Persona 4 actualizada: " + persona4.toJson());
            } else {
                System.out.println("No se encontró persona con id_persona = 4.");
            }

            System.out.println();
            System.out.println("== FIN de todas las operaciones ==");
        } catch (Exception e) {
            System.err.println("Error durante la ejecución: " + e.getMessage());
            e.printStackTrace();
        }
    }
}
