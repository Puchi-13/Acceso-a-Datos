import org.bson.Document;
import org.bson.conversions.Bson;
import com.mongodb.client.MongoClients;
import com.mongodb.client.MongoClient;
import com.mongodb.client.MongoDatabase;
import com.mongodb.client.MongoCollection;
import com.mongodb.client.MongoCursor;
import com.mongodb.client.model.Filters;
import com.mongodb.client.model.Projections;
import com.mongodb.client.model.Sorts;
import com.mongodb.client.model.Updates;

public class Concesionario {

    public static void main(String[] args) {

        MongoClient cliente = MongoClients.create();
        MongoDatabase db = cliente.getDatabase("Concesionario");
        MongoCollection<Document> coleccionPersonas = db.getCollection("Personas");
        MongoCollection<Document> coleccionCoches = db.getCollection("Coches");
        MongoCursor<Document> cursor;

        // 1. Buscar los coches Rolls en json
        System.out.println("1. Buscar los coches Rolls en json");
        cursor = coleccionCoches.find(Filters.eq("Model", "Rolls")).iterator();
        while (cursor.hasNext()) {
            System.out.println(cursor.next().toJson());
        }
        System.out.println();

        // 2. Buscar los coches Ford con su propietaria
        System.out.println("2. Buscar los coches Ford con su propietaria");
        cursor = coleccionCoches.find(Filters.eq("Model", "Ford")).iterator();
        while (cursor.hasNext()) {
            Document cocheFord = cursor.next();
            int idCar = cocheFord.getInteger("id_car");
            Document propietario = coleccionPersonas.find(Filters.in("coches", idCar)).first();
            if (propietario != null) {
                System.out.println("Propietario del Ford " + idCar + " - " + propietario.getString("surname"));
            }
        }
        System.out.println();
/*
        // 3. Ford año > 1995 y < 2000, ordenar por Value
        System.out.println("3. Coches Ford entre 1995 y 2000 ordenados por Value");
        Bson filtroEj3 = Filters.and(Filters.eq("Model", "Ford"), Filters.gt("Year", 1995), Filters.lt("Year", 2000));
        cursor = coleccionCoches.find(filtroEj3).sort(Sorts.ascending("Value")).iterator();
        while (cursor.hasNext()) {
            System.out.println(cursor.next().toJson());
        }
        System.out.println();

        // 4. Coche Ford o Rolls de la persona Juan, obtener matrícula
        System.out.println("4. Coche Ford o Rolls de la persona Juan, matrícula");
        Document personaJuan = coleccionPersonas.find(Filters.eq("surname", "Juan")).first();
        if (personaJuan != null) {
            cursor = coleccionCoches.find(Filters.and(Filters.or(Filters.eq("Model", "Ford"), Filters.eq("Model", "Rolls")),
                    Filters.in("id_car", personaJuan.getList("coches", Integer.class)))).iterator();
            while (cursor.hasNext()) {
                System.out.println("Matrícula: " + cursor.next().getString("Matrícula"));
            }
        }
        System.out.println();

        // 5. Proyección Model, Matrícula, Value de dueños de London y año < 1994, ordenados por Year
        System.out.println("5. Coches de dueños de London, año < 1994, proyección Model, Matrícula, Value");
        cursor = coleccionCoches.find(Filters.in("id_car",
                coleccionPersonas.find(Filters.eq("City", "London"))
                        .map(p -> p.getList("coches", Integer.class)))
        ).filter(Filters.lt("Year", 1994))
         .projection(Projections.include("Model", "Matrícula", "Value"))
         .sort(Sorts.ascending("Year")).iterator();
        while (cursor.hasNext()) {
            System.out.println(cursor.next().toJson());
        }
        System.out.println();

        // 6. Ciudad de personas con 2 coches
        System.out.println("6. Ciudad de personas con 2 coches");
        cursor = coleccionPersonas.find(Filters.size("coches", 2)).iterator();
        while (cursor.hasNext()) {
            System.out.println(cursor.next().getString("City"));
        }
        System.out.println();

        // 7. Coche que contenga "r" en modelo, ordenar por Model
        System.out.println("7. Coches con 'r' en modelo ordenados por Model");
        cursor = coleccionCoches.find(Filters.regex("Model", "r", "i")).sort(Sorts.ascending("Model")).iterator();
        while (cursor.hasNext()) {
            System.out.println(cursor.next().toJson());
        }
        System.out.println();

        // 8. Buscar propietario, nombre y ciudad del coche 107
        System.out.println("8. Propietario del coche 107");
        Document coche107 = coleccionCoches.find(Filters.eq("id_car", 107)).first();
        if (coche107 != null) {
            Document propietario107 = coleccionPersonas.find(Filters.in("coches", 107)).first();
            if (propietario107 != null) {
                System.out.println("Surname: " + propietario107.getString("surname"));
                System.out.println("Nombre: " + propietario107.getString("Name"));
                System.out.println("Ciudad: " + propietario107.getString("City"));
            }
        }
        System.out.println();

        // 9. Personas con 2 coches, mostrar surname
        System.out.println("9. Personas con 2 coches, surname");
        cursor = coleccionPersonas.find(Filters.size("coches", 2)).projection(Projections.include("surname")).iterator();
        while (cursor.hasNext()) {
            System.out.println(cursor.next().getString("surname"));
        }
        System.out.println();

        // 10. Modificar modelo del coche_id 101 valor 2000
        System.out.println("10. Modificar Value del coche 101 a 2000");
        coleccionCoches.updateOne(Filters.eq("id_car", 101), Updates.set("Value", 2000));
        Document coche101 = coleccionCoches.find(Filters.eq("id_car", 101)).first();
        System.out.println(coche101.toJson());
        System.out.println();

        // 11. Añadir coche Mercedes 2001 id_car 200 valor 3500
        System.out.println("11. Añadir coche Mercedes 2001");
        Document nuevoCoche = new Document("Model", "Mercedes").append("Year", 2001).append("id_car", 200)
                .append("Value", 3500);
        coleccionCoches.insertOne(nuevoCoche);
        System.out.println("Coche añadido: " + nuevoCoche.toJson());
        System.out.println();

        // 12. Modificar persona id_persona 4 y añadir coche id_car 200
        System.out.println("12. Añadir coche 200 a persona 4");
        coleccionPersonas.updateOne(Filters.eq("id_persona", 4), Updates.push("coches", 200));
        Document persona4 = coleccionPersonas.find(Filters.eq("id_persona", 4)).first();
        System.out.println(persona4.toJson());
        */
    }
}
