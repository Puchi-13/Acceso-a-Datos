import java.util.Arrays;
import java.util.Comparator;
import java.util.ArrayList;
import java.util.List;

import org.bson.Document;

import com.mongodb.client.FindIterable;
import com.mongodb.client.MongoClient;
import com.mongodb.client.MongoClients;
import com.mongodb.client.MongoCollection;
import com.mongodb.client.MongoCursor;
import com.mongodb.client.MongoDatabase;

import static com.mongodb.client.model.Filters.*;
import static com.mongodb.client.model.Projections.*;
import static com.mongodb.client.model.Sorts.*;
import static com.mongodb.client.model.Updates.*;

public class Concesionario {

	public static void main(String[] args) {
		MongoClient mongoCliente = null;

		try {
			mongoCliente = MongoClients.create();
			MongoDatabase bd = mongoCliente.getDatabase("Concesionario");
			MongoCollection<Document> colCoche = bd.getCollection("coche");
			MongoCollection<Document> colPersonas = bd.getCollection("personas");

			Document doc;
			MongoCursor<Document> cursor;

			// EJER 1: coches modelo Rolls
			System.out.println("\nEJER 1:");
			cursor = colCoche.find(eq("Model", "Rolls")).iterator();
			while (cursor.hasNext()) {
				doc = cursor.next();
				System.out.println(doc.toJson());
			}

			// EJER 2: coches Ford -> obtener surname de propietario
			System.out.println("\nEJER 2:");
			cursor = colCoche.find(eq("Model", "Ford")).iterator();
			while (cursor.hasNext()) {
				doc = cursor.next();
				Object idCar = doc.get("id_car");
				Document propietario = null;
				if (idCar != null) {
					propietario = colPersonas.find(eq("coches", idCar)).first();
					if (propietario == null)
						propietario = colPersonas.find(eq("coches", String.valueOf(idCar))).first();
				}
				String surname = propietario != null ? propietario.getString("surname") : "NO_ENCONTRADO";
				System.out.println("id_car=" + doc.get("id_car") + " -> surname: " + surname);
			}

			// EJER 3: coches Ford Year>1995 && <2000 -> Value
			System.out.println("\nEJER 3:");
			List<Document> list3 = new ArrayList<>();
			cursor = colCoche.find(and(eq("Model", "Ford"), gt("Year", 1995), lt("Year", 2000))).iterator();
			while (cursor.hasNext()) {
				doc = cursor.next();
				Object val = doc.get("Value");
				if (val == null)
					val = doc.get("Vallue");
				Document out = new Document("id_car", doc.get("id_car")).append("Year", doc.get("Year")).append("Value",
						val);
				list3.add(out);
			}
			list3.sort(Comparator.comparingInt(d -> {
				Object v = d.get("Value");
				if (v instanceof Number)
					return ((Number) v).intValue();
				try {
					return Integer.parseInt(String.valueOf(v));
				} catch (Exception e) {
					return 0;
				}
			}));
			for (Document r : list3)
				System.out.println(r.toJson());

			// EJER 4: matrícula coches de Juan
			System.out.println("\nEJER 4:");
			List<Document> juanes = colPersonas.find(eq("surname", "Juan")).into(new ArrayList<>());
			cursor = colCoche.find(in("Model", Arrays.asList("Ford", "Rolls"))).iterator();
			while (cursor.hasNext()) {
				doc = cursor.next();
				Object idCar = doc.get("id_car");
				boolean ownedByJuan = false;
				for (Document p : juanes) {
					if (idCar != null) {
						if (colPersonas.find(and(eq("surname", "Juan"), eq("coches", idCar))).first() != null
								|| colPersonas.find(and(eq("surname", "Juan"), eq("coches", String.valueOf(idCar))))
										.first() != null) {
							ownedByJuan = true;
							break;
						}
					}
				}
				if (ownedByJuan) {
					Object matricula = doc.get("Matrícula");
					if (matricula == null)
						matricula = doc.get("Mstrícula");
					System.out.println("id_car=" + idCar + " -> matricula: " + matricula);
				}
			}

			// EJER 5: coches de London y Year<1994 -> proyección Model, Matrícula, Value
			System.out.println("\nEJER 5:");
			List<Document> resultados5 = new ArrayList<>();
			cursor = colCoche.find(lt("Year", 1994)).iterator();
			while (cursor.hasNext()) {
				doc = cursor.next();
				Object idCar = doc.get("id_car");
				Document propietario = null;
				if (idCar != null) {
					propietario = colPersonas.find(eq("coches", idCar)).first();
					if (propietario == null)
						propietario = colPersonas.find(eq("coches", String.valueOf(idCar))).first();
				}
				if (propietario != null && "London".equalsIgnoreCase(propietario.getString("City"))) {
					Object val = doc.get("Value");
					if (val == null)
						val = doc.get("Vallue");
					Object mat = doc.get("Matrícula");
					if (mat == null)
						mat = doc.get("Mstrícula");
					Document out = new Document("Model", doc.get("Model")).append("Matrícula", mat).append("Value", val)
							.append("Year", doc.get("Year"));
					resultados5.add(out);
				}
			}
			resultados5.sort(Comparator.comparingInt(d -> d.getInteger("Year", 0)));
			for (Document r : resultados5)
				System.out.println(r.toJson());

			// EJER 6: personas con 2 coches -> ciudad
			System.out.println("\nEJER 6:");
			cursor = colPersonas.find(size("coches", 2)).projection(fields(include("City", "surname"), excludeId()))
					.iterator();
			while (cursor.hasNext()) {
				doc = cursor.next();
				System.out.println("surname: " + doc.getString("surname") + " -> City: " + doc.getString("City"));
			}

			// EJER 7: coches que contienen 'r' en Model, ordenados
			System.out.println("\nEJER 7:");
			FindIterable<Document> containsR = colCoche.find(regex("Model", "r", "i")).sort(ascending("Model"));
			for (Document d : containsR)
				System.out.println(d.toJson());

			// EJER 8: propietario del coche 107
			System.out.println("\nEJER 8:");
			doc = colCoche.find(eq("id_car", 107)).first();
			if (doc != null) {
				Object idCar = doc.get("id_car");
				Document propietario = colPersonas.find(eq("coches", idCar)).first();
				if (propietario == null)
					propietario = colPersonas.find(eq("coches", String.valueOf(idCar))).first();
				if (propietario != null) {
					System.out.println("surname: " + propietario.getString("surname") + ", City: "
							+ propietario.getString("City"));
				} else
					System.out.println("No encontrado propietario para id_car=107");
			} else
				System.out.println("No existe coche con id_car=107");

			// EJER 9: personas con 2 coches -> surname
			System.out.println("\nEJER 9:");
			cursor = colPersonas.find(size("coches", 2)).projection(fields(include("surname"), excludeId())).iterator();
			while (cursor.hasNext()) {
				doc = cursor.next();
				System.out.println("surname: " + doc.getString("surname"));
			}

			// EJER 10: modificar coche 101
			System.out.println("\nEJER 10:");
			colCoche.updateOne(eq("id_car", 101), combine(set("Model", "2000"), set("Year", 2000)));
			doc = colCoche.find(eq("id_car", 101)).first();
			System.out.println("Resultado: " + (doc != null ? doc.toJson() : "No encontrado"));

			// EJER 11: añadir coche Mercedes 2001 id=200
			System.out.println("\nEJER 11:");
			doc = new Document("id_car", 200).append("Model", "Mercedes").append("Year", 2001).append("Value", 3500)
					.append("Matrícula", "M-200");
			try {
				colCoche.insertOne(doc);
				System.out.println("Insertado: " + doc.toJson());
			} catch (Exception e) {
				colCoche.replaceOne(eq("id_car", 200), doc, new com.mongodb.client.model.ReplaceOptions().upsert(true));
				System.out.println("Upsert realizado para id_car=200");
			}

			// EJER 12: añadir coche 200 a persona 4
			System.out.println("\nEJER 12:");
			long matched = colPersonas.updateOne(eq("id_persona", 4), push("coches", 200)).getMatchedCount();
			if (matched == 0) {
				Document personaNueva = new Document("id_persona", 4).append("coches", Arrays.asList(200));
				colPersonas.insertOne(personaNueva);
				System.out.println("Persona id_persona=4 no existía: creada con el coche 200");
			} else
				System.out.println("Persona id_persona=4 actualizada: añadido coche 200");
		} finally {
			if (mongoCliente != null)
				mongoCliente.close();
		}
	}
}
