import org.bson.Document;
import org.bson.conversions.Bson;

import com.mongodb.ConnectionString;
import com.mongodb.client.MongoClients;
import com.mongodb.client.MongoClient;
import com.mongodb.client.MongoDatabase;
import com.mongodb.client.model.Filters;
import com.mongodb.client.model.Projections;
import com.mongodb.client.model.Sorts;
import com.mongodb.client.model.Updates;
import com.mongodb.client.MongoCollection;
import com.mongodb.client.MongoCursor;

public class Concesionario {

	public static void main(String[] args) {
		// Conectar a Mongo
		MongoClient conectarmongo = MongoClients.create();
		System.out.println("Conectado al mongoclient");
		// Conectar a BD
		MongoDatabase database = conectarmongo.getDatabase("Concesionario");
		System.out.println("Conectado a la base de datos de concesionario");
		// Conectar colecciones
		MongoCollection<Document> personas = database.getCollection("Personas");
		System.out.println("Coleccion personas conectado");
		MongoCollection<Document> coches = database.getCollection("Coches");
		System.out.println("Coleccion coches conectado");
		// Cursores para tener toda la lista

		MongoCursor<Document> cursor = null;

		// 1. Buscar los coche de modelo Rolls, obtener el json con la
		// información del coche.

		System.out.println("--EJ1--");
		Bson bsonEJ1 = Filters.eq("Model", "Rolls");
		cursor = coches.find(bsonEJ1).iterator();
		while (cursor.hasNext()) {
			System.out.println(cursor.next().toJson());
		}

	
		// 2. Buscar los coches modelo Ford,obtener de la colección coche el
		// surname de la persona propietaria.
		System.out.println("--EJ2--");

		
		Bson bsonEJ2 = Filters.eq("Model", "Ford");
		cursor = coches.find(bsonEJ2).iterator();

		while (cursor.hasNext()) {
	    System.out.println(cursor.next().toString());
		}

		
		// 3. Busca de los coches Ford del Year anterior al 2000 y posterior al
		// 1995, su Value y ordenarlos por este campo.
		System.out.println("--EJ3--");
		Bson bson3 = Filters.and(Filters.eq("Model", "Ford"), Filters.lt("Year", 2000), Filters.gt("Year", 1995));
		Bson ordenarej3 = Sorts.ascending("Value");
		cursor = coches.find(bson3).sort(ordenarej3).iterator();

		if (!cursor.hasNext()) { // No hay ninguno , por eso he puesto este mensaje (si cambias year a 2100 
			System.out.println("No hay ningún coche Ford entre 1995 y 2000.");
		} else {
			while (cursor.hasNext()) {
				System.out.println(cursor.next().toJson());
			}
		}

		// 4. Buscar el coche Ford o Rolls y de la persona Juan, obtener la
		// matrícula de los coches.
		System.out.println("--EJ4--");

		Bson filtroCocheej4 = Filters.or(Filters.eq("Model","Ford"),Filters.eq("Model","Rolls")); //Filtro or para que pueda ser 1 o otra opcion
		Document cocheej4 = coches.find(filtroCocheej4).first(); //Busca por el doc coches el primero que cumpla con el filtro

			Bson filtroPersonaej4 = Filters.eq("surname", "Juan"); //filtro bson en personas para buscar a Juan
				String matricula = cocheej4.getString("Matrícula"); 

				System.out.println("Coche de Juan:");
				System.out.println("Mátricula: " + matricula);

		
		
				

		/* ---------------------No he logrado terminar este ej.----------------
		 * 
		 * 
		 * 
		 * 5. Coches, obtener una proyección con la Model, Matrícula y Value, cuyos
		 * dueños (colección persona) son de la ciudad de «London» y del año menor 1994,
		 * ordenados por año.	
		 
		
		System.out.println("--EJ5--");
		Bson proyeccioncoche = Projections.include
				("Model","Matrícula","Value"); //campos que debemos mostrar
		Bson filtrosej5 = Filters.and(Filters.eq("City","London"),
				(Filters.lt("Year", 1994))); //filtros de ciudad y del año
		Bson ordenarej5 = Sorts.ascending("Year");
		
		cursor = coches.find(filtrosej5)
	               .projection(proyeccioncoche)
	               .sort(ordenarej5)
	               .iterator(); 
		
		while(cursor.hasNext()) {
			System.out.println(cursor.next().toJson());
		}
		*/
			
				
		// 6. Obtener la ciudad de las personas que tienen dos coches
		System.out.println("--EJ6--");
		Bson bson6 = Filters.size("coches", 2);
		cursor = personas.find(bson6).iterator();
		if (!cursor.hasNext()) {
			System.out.println("No hay ninguna persona con 2 coches");
		} else {
			while (cursor.hasNext()) {
				System.out.println(cursor.next().toJson());
			}
		}

		/*
		 * 7. Buscar el coche, obtener json con toda la información, que contiene el
		 * modelo una «r» (investiga con que función puedes buscar en una cadena),
		 * ordenados por marca.
		 */
		System.out.println("--EJ7--");
		Bson bsonEJ7 = Filters.regex("Model","r","i"); //al investigar he encontrado la función 'regex', que busca patrones en una cadena de texto
		//el "i" en la función regex es para que lo encuentre sea mayuscula o minuscula
		Bson ordenar = Sorts.ascending("Model"); //sort para ordenarlo de forma ascendente
		
		cursor = coches.find(bsonEJ7).sort(ordenar).iterator();
		
		while(cursor.hasNext()) {
			System.out.println(cursor.next().toJson());
		}
		
		
		// 8. Buscar la persona «surname» propietaria, nombre y ciudad del coche 107
		System.out.println("--EJ8--");
		
		Bson filtroCoche = Filters.eq("id_car", 107); //Filtro bson para que el id sea igual a 107
		Document coche = coches.find(filtroCoche).first(); //Busca por el doc coches el primero que cumpla con el filtro

		if (coche == null) { //si no hay coche pone esto
			System.out.println("No hay un coche con id_car = 107");
		} else {
			Bson filtroPersona = Filters.in("coches", 107); //filtro bson donde coches tenga el id 107
			Document persona = personas.find(filtroPersona).first(); //lo mismo que document coche pero personas

			if (persona == null) {
				System.out.println("No se encontró la persona propietaria del coche 107.");
			} else {
				String surname = persona.getString("surname"); //Si lo encuentra muestra el mensaje
				String city = persona.getString("City"); //muestra ciudad tmb

				System.out.println("Propietario del coche 107:");
				System.out.println("Nombre: " + surname);
				System.out.println("Ciudad: " + city);
			}
		}

		//9. Buscar personas con 2 coches, muestra una proyección con el surname
		System.out.println("--EJ9--");
		Bson cochesej9 = Filters.size("coches", 2);
		//proyeccion para mostrar el campo surname
		Bson proyeccionej9 = Projections.include("surname"); //proyeccion para incluir el campo surname
		
		cursor = personas.find(cochesej9) //cursor para encontrar el filtro de coches
				.projection(proyeccionej9) //tambien la proyeccion para incluir el filtro de personas
				.iterator(); //para que vaya uno a uno
		
		while(cursor.hasNext()) {
			Document persona = cursor.next();
			System.out.println("Nombre: "+persona.getString("surname"));
		}
		
		//10. Modificar el modelo del coche_id 101 valor 2000.
		System.out.println("--EJ10--");
		
		//he usado updateOne para actualizar el campo value
		//SOLO con el que tenga id 101 como pone en el doc. de aules
		coches.updateOne(Filters.eq("id_car",101), 
				new Document("$set", new Document("Value",3500)));
		
		//De aqui a abajo es para que se muestre tambien desde la consola,
		//ya que asi no hace falta ir a comprobarlo en mongoDB manualmente 
		Bson filtromostrarej10 = Filters.and(
				Filters.eq("id_car",101),
				Filters.eq("Value",3500));
		cursor = coches.find(filtromostrarej10).iterator();
		
		while(cursor.hasNext()) {
		Document resultadoej10 = cursor.next();
		System.out.println("Ha sido cambiado con exito: "+resultadoej10.toJson());
		}
		
		//11. Añadir un coche Modelo Mercedes año:2001 id_coche:200 valor:3500.
		System.out.println("--EJ11--");
		Document nuevocoche = new Document("Model","Mercedes")
				.append("id_car", 200)
				.append("Value", 3500);
		
		coches.insertOne(nuevocoche);
		System.out.println("Coche añadido con éxito!");
		
		//12. Modificarla persona con id_persona:4 y añade a su array de coches
		//el nuevo coche con id_coche:200
		System.out.println("--EJ12--");
		Bson bsonej12 = Filters.eq("id_persona",4);
		Bson ponercocheej12 = Updates.push("coches", 200);
		personas.updateOne(bsonej12,ponercocheej12);
		
		//Mostrarlo en consola
		cursor = personas.find(bsonej12).iterator();
		while (cursor.hasNext()) {
		    Document persona = cursor.next();
		    System.out.println("La persona 4 ha sido actualizada: " + persona.toJson());
		}
	}
}
